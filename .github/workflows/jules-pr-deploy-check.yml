name: Jules PR & Deploy Check
# v1.2 - Verified
# Managed by Jules (Daily Schedule)
on:
  schedule:
    # 08:45 IST (India Standard Time) = 03:15 UTC
    - cron: "15 3 * * *"
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  create-jules-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create Issue
        uses: actions/github-script@v7
        env:
          PROMPT_FILE: jules-prompts/pr-deploy-check.md
          ISSUE_TITLE: "[Jules] PR & Deploy Check"
        with:
          script: |
            const fs = require('fs');
            const promptFile = process.env.PROMPT_FILE;
            const baseTitle = process.env.ISSUE_TITLE;

            // Generate today's date string (YYYY-MM-DD)
            const date = new Date().toISOString().split('T')[0];
            const title = `${baseTitle} - ${date}`;

            // Read the prompt file
            let body = '';
            try {
              body = fs.readFileSync(promptFile, 'utf8');
            } catch (error) {
              console.error(`Error reading prompt file: ${error.message}`);
              core.setFailed('Failed to read prompt file.');
              return;
            }

            // Check for existing open issues with the same title
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            console.log("Checking for duplicate issue with title: " + title);

            // Find strictly matching title
            const duplicate = existingIssues.find(issue => issue.title === title);

            if (duplicate) {
              console.log(`Issue already exists: ${duplicate.html_url}`);
              return;
            }

            // Check if label exists, create if not
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'jules'
              });
            } catch (error) {
              if (error.status === 404) {
                console.log('Label "jules" not found. Creating it...');
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'jules',
                  color: '0E8A16', // Green color
                  description: 'Tasks for Jules AI'
                });
              } else {
                throw error;
              }
            }

            // Create the issue
            const { data: newIssue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['jules']
            });

            console.log(`Created issue: ${newIssue.html_url}`);
