name: Jules PR Deploy Check

on:
  schedule:
    - cron: '15 3 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  create-issue:
    runs-on: ubuntu-latest
    env:
      PROMPT_FILE: jules-prompts/pr-deploy-check.md
      ISSUE_TITLE_BASE: PR Deploy Check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const promptFile = process.env.PROMPT_FILE;
            const titleBase = process.env.ISSUE_TITLE_BASE;

            if (!promptFile || !titleBase) {
              throw new Error("Missing required env vars: PROMPT_FILE or ISSUE_TITLE_BASE");
            }

            const today = new Date().toISOString().split('T')[0];
            const title = `[Jules] ${titleBase} - ${today}`;

            // Check for existing issue
            const { data: issues } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue "${title}"`
            });

            if (issues.total_count > 0) {
              console.log(`Issue "${title}" already exists. Skipping.`);
              return;
            }

            try {
              if (!fs.existsSync(promptFile)) {
                 throw new Error(`Prompt file not found: ${promptFile}`);
              }
              const body = fs.readFileSync(promptFile, 'utf8');

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['jules']
              });
              console.log(`Created issue: ${title}`);
            } catch (error) {
              console.error(`Failed to read prompt file: ${promptFile}`);
              throw error;
            }
