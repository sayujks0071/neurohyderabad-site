name: Lighthouse CI

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  schedule:
    # Run daily at 2 AM UTC (7:30 AM IST)
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: false
    
    - name: Setup Node.js
      uses: pnpm/action-setup@v4

      with:

        version: 9

      - name: Setup Node.js

        uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
    
    - name: Install dependencies
      run: pnpm install
      timeout-minutes: 5
      continue-on-error: false
    
    - name: Build application
      run: pnpm build
      timeout-minutes: 10
      continue-on-error: false
      env:
        NEXT_PUBLIC_GOOGLE_ANALYTICS_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID }}
    
    - name: Run Lighthouse CI
      run: pnpm exec lhci autorun --config=./lighthouserc.js
      timeout-minutes: 20
      continue-on-error: true
    
    - name: Upload Lighthouse results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lighthouse-results
        path: .lighthouseci/
        retention-days: 7

    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      continue-on-error: true
      timeout-minutes: 2
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const reportPath = '.lighthouseci';
            if (!fs.existsSync(reportPath)) {
              console.log('No lighthouse reports found');
              return;
            }
            const files = fs.readdirSync(reportPath);
            const latestReport = files
              .filter(f => f.endsWith('.json'))
              .sort()
              .pop();
            
            if (latestReport) {
              const report = JSON.parse(fs.readFileSync(path.join(reportPath, latestReport), 'utf8'));
              const categories = report.categories;
              
              const scores = Object.entries(categories).map(([key, value]) => {
                const score = Math.round(value.score * 100);
                const emoji = score >= 90 ? 'ðŸŸ¢' : score >= 50 ? 'ðŸŸ¡' : 'ðŸ”´';
                return `${emoji} **${value.title}**: ${score}/100`;
              }).join('\n');
              
              const comment = `## ðŸ”¦ Lighthouse CI Results\n\n${scores}\n\n[View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          } catch (error) {
            console.log('Could not post comment:', error.message);
          }
