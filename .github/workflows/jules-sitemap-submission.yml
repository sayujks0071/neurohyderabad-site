name: "Jules: Daily Sitemap Submission"

on:
  schedule:
    # 09:00 UTC as requested
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  create-jules-task:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Issue for Jules
        uses: actions/github-script@v7
        env:
          PROMPT_FILE: jules-prompts/daily-sitemap-submission.md
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const promptFile = process.env.PROMPT_FILE;
            const today = new Date().toISOString().split('T')[0];
            const title = `[Jules] Daily Sitemap Submission - ${today}`;

            // Check for existing open issue to prevent duplicates
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              creator: 'github-actions[bot]',
              labels: 'jules'
            });

            const alreadyExists = existingIssues.some(issue => issue.title === title);

            if (alreadyExists) {
              console.log(`Issue "${title}" already exists. Skipping.`);
              return;
            }

            try {
              const body = fs.readFileSync(promptFile, 'utf8');

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['jules']
              });

              console.log(`Created issue: ${title}`);
            } catch (error) {
              console.error('Error reading prompt file or creating issue:', error);
              core.setFailed(error.message);
            }
