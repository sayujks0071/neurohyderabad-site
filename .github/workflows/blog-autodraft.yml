name: Blog Auto-Draft

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Blog post title'
        required: true
        type: string
      category:
        description: 'Blog category'
        required: false
        type: choice
        options:
          - spine
          - brain
          - epilepsy
          - general
          - recovery
          - cost-guide
          - patient-education
          - technology
          - research
        default: general
      primaryKeyword:
        description: 'Primary SEO keyword'
        required: false
        type: string
      targetLocations:
        description: 'Target locations (comma-separated, e.g., "Hyderabad,Malakpet")'
        required: false
        type: string
      useAI:
        description: 'Use AI to generate initial content'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  create-blog-draft:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        timeout-minutes: 5
      
      - name: Generate blog post
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Build command arguments
          CMD_ARGS="--title \"${{ github.event.inputs.title }}\""
          
          if [ -n "${{ github.event.inputs.category }}" ]; then
            CMD_ARGS="$CMD_ARGS --category ${{ github.event.inputs.category }}"
          fi
          
          if [ -n "${{ github.event.inputs.primaryKeyword }}" ]; then
            CMD_ARGS="$CMD_ARGS --primaryKeyword \"${{ github.event.inputs.primaryKeyword }}\""
          fi
          
          if [ -n "${{ github.event.inputs.targetLocations }}" ]; then
            CMD_ARGS="$CMD_ARGS --targetLocations \"${{ github.event.inputs.targetLocations }}\""
          fi
          
          if [ "${{ github.event.inputs.useAI }}" == "true" ]; then
            CMD_ARGS="$CMD_ARGS --ai"
          fi
          
          # Run the blog generation script
          npm run new:blog -- $CMD_ARGS
        timeout-minutes: 10
        continue-on-error: false
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'draft: Add blog post - ${{ github.event.inputs.title }}'
          title: 'üìù Draft blog: ${{ github.event.inputs.title }}'
          body: |
            ## üìù Blog Draft Created
            
            This PR contains a new blog post draft generated via GitHub Actions.
            
            **Title**: ${{ github.event.inputs.title }}
            **Category**: ${{ github.event.inputs.category || 'general' }}
            **Primary Keyword**: ${{ github.event.inputs.primaryKeyword || 'N/A' }}
            
            ### Next Steps
            
            - [ ] Review the generated content
            - [ ] Update frontmatter (excerpt, description, tags, etc.)
            - [ ] Refine the content for medical accuracy
            - [ ] Add sources to `app/blog/sources.ts`
            - [ ] Add internal links to related conditions/treatments
            - [ ] Review SEO metadata
            - [ ] Test locally: `npm run dev`
            
            ### Important Notes
            
            - This is a **draft** - content may need medical review
            - Ensure all medical claims are evidence-based
            - Add appropriate disclaimers
            - Verify all internal links work correctly
            
            ---
            
            **Generated by**: Blog Auto-Draft workflow  
            **Workflow Run**: ${{ github.run_id }}
          branch: blog-draft/${{ github.run_id }}
          delete-branch: true
          labels: blog,draft,automated

