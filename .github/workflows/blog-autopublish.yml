name: Blog Auto-Publish

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Blog post title'
        required: true
        type: string
      category:
        description: 'Blog category'
        required: false
        type: choice
        options:
          - spine
          - brain
          - epilepsy
          - general
          - recovery
          - cost-guide
          - patient-education
          - technology
          - research
        default: general
      primaryKeyword:
        description: 'Primary SEO keyword'
        required: false
        type: string
      targetLocations:
        description: 'Target locations (comma-separated, e.g., "Hyderabad,Malakpet")'
        required: false
        type: string
      useAI:
        description: 'Use AI to generate initial content'
        required: false
        type: boolean
        default: false
      publishDate:
        description: 'Publish date (YYYY-MM-DD, leave empty for immediate)'
        required: false
        type: string
  schedule:
    # Check for scheduled posts every hour
    - cron: '0 * * * *'
  push:
    branches:
      - main
    paths:
      - 'content/blog/**'

permissions:
  contents: write

jobs:
  auto-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        timeout-minutes: 5
      
      - name: Configure Git
        run: |
          git config user.name "Blog Auto-Publisher"
          git config user.email "blog-autopublisher@drsayuj.info"
      
      - name: Generate and publish blog post (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Build command arguments
          CMD_ARGS="--title \"${{ github.event.inputs.title }}\""
          
          if [ -n "${{ github.event.inputs.category }}" ]; then
            CMD_ARGS="$CMD_ARGS --category ${{ github.event.inputs.category }}"
          fi
          
          if [ -n "${{ github.event.inputs.primaryKeyword }}" ]; then
            CMD_ARGS="$CMD_ARGS --primaryKeyword \"${{ github.event.inputs.primaryKeyword }}\""
          fi
          
          if [ -n "${{ github.event.inputs.targetLocations }}" ]; then
            CMD_ARGS="$CMD_ARGS --targetLocations \"${{ github.event.inputs.targetLocations }}\""
          fi
          
          if [ "${{ github.event.inputs.useAI }}" == "true" ]; then
            CMD_ARGS="$CMD_ARGS --ai"
          fi
          
          # Run the blog generation script
          npm run new:blog -- $CMD_ARGS
          
          # Get the generated slug
          SLUG=$(echo "${{ github.event.inputs.title }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          
          # Update publish date if specified
          if [ -n "${{ github.event.inputs.publishDate }}" ]; then
            FILE_PATH="content/blog/${SLUG}.mdx"
            if [ -f "$FILE_PATH" ]; then
              # Update publishedAt in frontmatter
              sed -i.bak "s/publishedAt:.*/publishedAt: \"${{ github.event.inputs.publishDate }}\"/" "$FILE_PATH"
              rm -f "${FILE_PATH}.bak"
            fi
          fi
          
          # Commit and push directly to main
          git add content/blog/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìù Auto-publish blog: ${{ github.event.inputs.title }}" || exit 0
            git push origin main || exit 0
          fi
        timeout-minutes: 10
        continue-on-error: false
      
      - name: Publish scheduled posts
        if: github.event_name == 'schedule' || (github.event_name == 'push' && contains(github.event.head_commit.message, 'scheduled'))
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Check for posts scheduled for today or earlier
          TODAY=$(date +%Y-%m-%d)
          
          # Find all blog files
          for file in content/blog/*.mdx content/blog/*.md; do
            if [ ! -f "$file" ]; then
              continue
          fi
            
            # Extract scheduled date from frontmatter
            SCHEDULED_DATE=$(grep -E "^scheduledAt:" "$file" | head -1 | sed 's/scheduledAt: *"\(.*\)"/\1/' | sed 's/scheduledAt: *\(.*\)/\1/' | tr -d ' "')
            PUBLISHED_DATE=$(grep -E "^publishedAt:" "$file" | head -1 | sed 's/publishedAt: *"\(.*\)"/\1/' | sed 's/publishedAt: *\(.*\)/\1/' | tr -d ' "')
            
            # Check if post is scheduled for today or earlier
            if [ -n "$SCHEDULED_DATE" ] && [ "$SCHEDULED_DATE" != "null" ]; then
              if [ "$SCHEDULED_DATE" <= "$TODAY" ]; then
                # Update publishedAt to scheduled date
                sed -i.bak "s/publishedAt:.*/publishedAt: \"$SCHEDULED_DATE\"/" "$file"
                # Remove scheduledAt field
                sed -i.bak "/^scheduledAt:/d" "$file"
                rm -f "${file}.bak"
                
                echo "üìÖ Publishing scheduled post: $(basename $file) (scheduled for $SCHEDULED_DATE)"
              fi
            fi
          done
          
          # Commit any changes
          git add content/blog/
          if git diff --staged --quiet; then
            echo "No scheduled posts to publish"
          else
            git commit -m "üìÖ Auto-publish scheduled blog posts - $(date +%Y-%m-%d)"
            git push origin main
          fi
        timeout-minutes: 5
        continue-on-error: true

