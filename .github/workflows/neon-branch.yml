# Neon Database Branching for Pull Requests
# Creates a database branch for each PR, deleted when PR is closed
# https://neon.tech/docs/guides/branching-github-actions

name: Neon Database Branch

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

env:
  NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
  NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  create-branch:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      db_url: ${{ steps.create-branch.outputs.db_url }}
      db_url_with_pooler: ${{ steps.create-branch.outputs.db_url_with_pooler }}
      branch_id: ${{ steps.create-branch.outputs.branch_id }}

    steps:
      - name: Create Neon Branch
        id: create-branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ env.NEON_PROJECT_ID }}
          branch_name: pr-${{ github.event.pull_request.number }}
          api_key: ${{ env.NEON_API_KEY }}
          username: neondb_owner
          # Parent branch defaults to the default branch (main)

      - name: Comment on PR with Database URL
        uses: actions/github-script@v7
        with:
          script: |
            const branchId = '${{ steps.create-branch.outputs.branch_id }}';
            const comment = `## ðŸ—ƒï¸ Neon Database Branch Created

            A preview database branch has been created for this PR.

            | Property | Value |
            |----------|-------|
            | Branch ID | \`${branchId}\` |
            | Branch Name | \`pr-${{ github.event.pull_request.number }}\` |

            **Note:** The database URL has been set as an environment variable for Vercel preview deployments.

            The branch will be automatically deleted when this PR is closed.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Set Database URL for Vercel Preview
        if: steps.create-branch.outputs.db_url_with_pooler != ''
        run: |
          echo "Preview database branch created successfully"
          echo "Branch ID: ${{ steps.create-branch.outputs.branch_id }}"
          # The Vercel integration will automatically use this branch for previews

  delete-branch:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest

    steps:
      - name: Delete Neon Branch
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ env.NEON_PROJECT_ID }}
          branch: pr-${{ github.event.pull_request.number }}
          api_key: ${{ env.NEON_API_KEY }}

      - name: Comment on PR - Branch Deleted
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ—‘ï¸ Neon Database Branch Deleted\n\nThe preview database branch `pr-${{ github.event.pull_request.number }}` has been deleted.'
            });

  # Run database migrations on the branch (optional)
  migrate:
    needs: create-branch
    if: github.event.action != 'closed' && needs.create-branch.outputs.db_url != ''
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Schema Migration
        env:
          DATABASE_URL: ${{ needs.create-branch.outputs.db_url_with_pooler }}
        run: |
          echo "Running schema migration on preview branch..."
          # Apply the schema to the new branch
          node -e "
            const { neon } = require('@neondatabase/serverless');
            const fs = require('fs');
            const sql = neon(process.env.DATABASE_URL);
            const schema = fs.readFileSync('src/lib/db/schema.sql', 'utf8');
            sql.query(schema).then(() => console.log('Schema applied successfully')).catch(e => {
              console.error('Schema migration failed:', e.message);
              process.exit(1);
            });
          "
