name: Broken Link Checker

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 3 AM UTC (8:30 AM IST)
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 5
        continue-on-error: false

      - name: Build site
        run: npm run build
        timeout-minutes: 10
        continue-on-error: false
        env:
          NEXT_PUBLIC_GOOGLE_ANALYTICS_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID }}

      - name: Check for broken links
        id: link-check
        timeout-minutes: 20
        continue-on-error: true
        run: |
          npx broken-link-checker https://neurohyderabad.org \
            --recursive \
            --verbose \
            --exclude "linkedin.com" \
            --exclude "twitter.com" \
            --exclude "facebook.com" \
            --exclude "instagram.com" \
            --ordered \
            --filter-level 3 > link-report.txt 2>&1 || true
          
          echo "Link check completed"
          cat link-report.txt

      - name: Parse and create issue for broken links
        if: always()
        continue-on-error: true
        timeout-minutes: 2
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const report = fs.readFileSync('link-report.txt', 'utf8');
              const brokenLinks = [];
              
              // Parse broken links from report
              const lines = report.split('\n');
              let currentUrl = '';
              
              for (const line of lines) {
                if (line.includes('Getting links from:')) {
                  currentUrl = line.split('Getting links from:')[1].trim();
                } else if (line.includes('âœ—') || line.includes('BROKEN')) {
                  brokenLinks.push({ page: currentUrl, issue: line.trim() });
                }
              }
              
              if (brokenLinks.length > 0) {
                const issueBody = `## ðŸ”— Broken Links Found\n\n` +
                  `Found ${brokenLinks.length} broken link(s) on the site.\n\n` +
                  `### Details:\n\n` +
                  brokenLinks.slice(0, 20).map(link => 
                    `- **Page**: ${link.page}\n  **Issue**: ${link.issue}`
                  ).join('\n\n') +
                  (brokenLinks.length > 20 ? `\n\n_...and ${brokenLinks.length - 20} more_` : '') +
                  `\n\n---\n` +
                  `**Action Required**: Please review and fix these broken links.\n` +
                  `Run triggered by: ${context.eventName}\n` +
                  `[View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
                
                // Check for existing open issue
                const issues = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'broken-links'
                });
                
                if (issues.data.length > 0) {
                  // Update existing issue
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issues.data[0].number,
                    body: `## ðŸ”„ Updated Report\n\n${issueBody}`
                  });
                } else {
                  // Create new issue
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `ðŸ”— Broken Links Detected - ${new Date().toISOString().split('T')[0]}`,
                    body: issueBody,
                    labels: ['broken-links', 'bug', 'seo']
                  });
                }
              } else {
                console.log('âœ… No broken links found!');
              }
            } catch (error) {
              console.log('Error processing link report:', error.message);
            }

      - name: Upload link check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: broken-link-report
          path: link-report.txt
          retention-days: 30
