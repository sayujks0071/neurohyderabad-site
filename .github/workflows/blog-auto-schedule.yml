name: Blog Auto-Schedule

on:
  schedule:
    # Run every day at 6:00 AM IST (00:30 UTC)
    - cron: '30 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  auto-schedule:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        timeout-minutes: 5
      
      - name: Configure Git
        run: |
          git config user.name "Blog Auto-Scheduler"
          git config user.email "blog-autoscheduler@drsayuj.info"
      
      - name: Generate and publish scheduled posts
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Generate posts scheduled for today
          npm run blog:generate-today || echo "No posts to generate today"
          
          # Publish any scheduled posts ready to go live
          npm run blog:auto-publish || echo "No posts to publish"
          
          # Commit and push all changes
          git add content/blog/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-scheduled blog posts - $(date +%Y-%m-%d)" || exit 0
            git push origin main || exit 0
          fi
        timeout-minutes: 15
        continue-on-error: true

