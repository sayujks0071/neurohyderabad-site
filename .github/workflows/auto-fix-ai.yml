name: Auto-Fix AI PR Bot

on:
  workflow_run:
    workflows:
      - "Lighthouse CI"
      - "Broken Link Checker"
      - "SEO Metadata Validator"
      - "Schema Validator"
      - "Image Audit"
      - "Accessibility Audit"
      - "Security Scan"
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  autofix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download workflow artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          merge-multiple: true
          path: artifacts

      - name: Aggregate all reports
        id: read_reports
        run: |
          echo "### AutoFix Report" > report.md
          echo "" >> report.md
          find artifacts -type f -print0 | while IFS= read -r -d '' f; do
            echo "#### File: $f" >> report.md
            echo '```' >> report.md
            cat "$f" >> report.md
            echo '```' >> report.md
            echo "" >> report.md
          done

      - name: Generate Patch with AI
        id: ai_patch
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          response=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-4.1-mini",
              "messages": [
                {
                  "role": "system",
                  "content": "You are an expert web developer. You will receive SEO, performance, link, schema, and accessibility reports. Create ONLY a git patch that fixes the issues safely, minimally, and without modifying unrelated code."
                },
                {
                  "role": "user",
                  "content": "'"$(sed 's/"/\\"/g' report.md)"'"
                }
              ],
              "temperature": 0,
              "response_format": { "type": "text" }
            }')

          echo "$response" | jq -r '.choices[0].message.content' > patch.diff

      - name: Check if patch is non-empty
        id: patchcheck
        run: |
          if [ -s patch.diff ]; then
            echo "patch_available=true" >> $GITHUB_OUTPUT
          else
            echo "patch_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Apply patch
        if: steps.patchcheck.outputs.patch_available == 'true'
        run: |
          git apply patch.diff || echo "Patch failed to apply"

      - name: Create PR with fixes
        if: steps.patchcheck.outputs.patch_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Auto-fix: SEO / Performance / Schema / Link issues"
          title: "ðŸ¤– Auto-Fix Bot: Automated Improvements"
          body: |
            This PR was automatically generated by the Auto-Fix AI Bot.

            It includes fixes for:
            - Lighthouse performance issues
            - SEO metadata issues
            - JSON-LD/schema errors
            - Broken links
            - Accessibility violations
            - Image optimization suggestions
            - Security issues

            Please review and merge.
          branch: "autofix/ai-${{ github.run_id }}"
          labels: "autofix, ai, automated"
          assignees: "drsayuj"
