name: Image Optimization

on:
  pull_request:
    branches: [main]
    paths:
      - 'public/**/*.{jpg,jpeg,png,webp,gif,svg}'
      - 'app/**/*.{jpg,jpeg,png,webp,gif,svg}'
  workflow_dispatch:

jobs:
  optimize-images:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install sharp for image optimization
        timeout-minutes: 3
        continue-on-error: false
        run: npm install sharp

      - name: Optimize images
        timeout-minutes: 15
        continue-on-error: true
        run: |
          cat > optimize-images.js << 'EOF'
          const sharp = require('sharp');
          const fs = require('fs');
          const path = require('path');
          
          async function optimizeImage(filePath) {
            try {
              const ext = path.extname(filePath).toLowerCase();
              const stats = fs.statSync(filePath);
              const originalSize = stats.size;
              
              let sharpInstance = sharp(filePath);
              
              // Get metadata
              const metadata = await sharpInstance.metadata();
              
              // Skip if already optimized or too small
              if (originalSize < 10000) {
                console.log(`‚úÖ ${filePath} - Already small (${(originalSize / 1024).toFixed(2)} KB)`);
                return { optimized: false, saved: 0 };
              }
              
              // Resize if too large
              if (metadata.width > 2000) {
                sharpInstance = sharpInstance.resize(2000, null, {
                  withoutEnlargement: true
                });
              }
              
              // Optimize based on format
              if (ext === '.jpg' || ext === '.jpeg') {
                await sharpInstance
                  .jpeg({ quality: 85, progressive: true })
                  .toFile(filePath + '.tmp');
              } else if (ext === '.png') {
                await sharpInstance
                  .png({ quality: 90, compressionLevel: 9 })
                  .toFile(filePath + '.tmp');
              } else if (ext === '.webp') {
                await sharpInstance
                  .webp({ quality: 85 })
                  .toFile(filePath + '.tmp');
              } else {
                return { optimized: false, saved: 0 };
              }
              
              const newStats = fs.statSync(filePath + '.tmp');
              const newSize = newStats.size;
              const saved = originalSize - newSize;
              const percent = ((saved / originalSize) * 100).toFixed(2);
              
              // Only replace if we saved space
              if (saved > 0) {
                fs.renameSync(filePath + '.tmp', filePath);
                console.log(`‚úÖ ${filePath} - Saved ${(saved / 1024).toFixed(2)} KB (${percent}%)`);
                return { optimized: true, saved };
              } else {
                fs.unlinkSync(filePath + '.tmp');
                console.log(`‚ÑπÔ∏è ${filePath} - No optimization needed`);
                return { optimized: false, saved: 0 };
              }
            } catch (error) {
              console.error(`‚ùå Error optimizing ${filePath}:`, error.message);
              return { optimized: false, saved: 0 };
            }
          }
          
          async function findImages(dir, images = []) {
            const files = fs.readdirSync(dir);
            
            for (const file of files) {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);
              
              if (stat.isDirectory()) {
                if (!filePath.includes('node_modules') && !filePath.includes('.next')) {
                  await findImages(filePath, images);
                }
              } else {
                const ext = path.extname(file).toLowerCase();
                if (['.jpg', '.jpeg', '.png', '.webp'].includes(ext)) {
                  images.push(filePath);
                }
              }
            }
            
            return images;
          }
          
          async function main() {
            console.log('üñºÔ∏è  Starting Image Optimization\n');
            
            const images = await findImages('./public');
            console.log(`Found ${images.length} images to process\n`);
            
            let totalSaved = 0;
            let optimizedCount = 0;
            
            for (const image of images) {
              const result = await optimizeImage(image);
              if (result.optimized) {
                optimizedCount++;
                totalSaved += result.saved;
              }
            }
            
            console.log('\n' + '='.repeat(60));
            console.log('üìä Summary:');
            console.log('='.repeat(60));
            console.log(`Total images processed: ${images.length}`);
            console.log(`Images optimized: ${optimizedCount}`);
            console.log(`Total space saved: ${(totalSaved / 1024).toFixed(2)} KB`);
            
            // Write summary for GitHub Actions
            fs.writeFileSync('optimization-summary.txt', 
              `Optimized ${optimizedCount} images\nSaved ${(totalSaved / 1024).toFixed(2)} KB total`);
          }
          
          main().catch(console.error);
          EOF
          
          node optimize-images.js || echo "No images to optimize or optimization completed with warnings"

      - name: Create Pull Request with optimizations
        if: success() && github.event_name == 'pull_request'
        timeout-minutes: 3
        continue-on-error: true
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: optimize images for performance'
          title: 'üñºÔ∏è Automated Image Optimization'
          body: |
            ## Image Optimization Results
            
            This PR contains automatically optimized images to improve site performance.
            
            **Changes:**
            - Compressed JPEG/PNG/WebP images
            - Resized oversized images
            - Applied progressive encoding
            
            **Benefits:**
            - Faster page load times
            - Reduced bandwidth usage
            - Better Core Web Vitals scores
            
            Please review and merge if the changes look good.
          branch: automated-image-optimization
          delete-branch: true

      - name: Comment optimization summary
        if: github.event_name == 'pull_request'
        timeout-minutes: 2
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = 'No optimization summary available';
            
            try {
              summary = fs.readFileSync('optimization-summary.txt', 'utf8');
            } catch (e) {
              console.log('No summary file found');
            }
            
            const comment = `## üñºÔ∏è Image Optimization Report\n\n${summary}\n\n` +
              `[View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload image optimization summary
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: image-optimization-summary
          path: optimization-summary.txt
          retention-days: 30
