name: IndexNow SEO Submission

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'src/**'
      - 'public/**'
      - 'app/sitemap.ts'
  workflow_dispatch:
  workflow_run:
    workflows: ["Blog Publisher"]
    branches: [main]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  submit-indexnow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build sitemap
        run: npm run build
        env:
          NEXT_PUBLIC_GOOGLE_ANALYTICS_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID && secrets.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID || 'G-MMLQCFN4ZJ' }}

      - name: Extract URLs from sitemap
        id: extract-urls
        run: |
          # Parse generated sitemap.xml and collect URLs (cap at 9,000 to stay under IndexNow limits)
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');
          const sitemapPath = path.join(process.cwd(), 'public', 'sitemap.xml');
          const fallback = [
            'https://www.drsayuj.info/',
            'https://www.drsayuj.info/about',
            'https://www.drsayuj.info/appointments',
            'https://www.drsayuj.info/services',
            'https://www.drsayuj.info/conditions',
            'https://www.drsayuj.info/blog'
          ];

          let urls = [];
          try {
            const xml = fs.readFileSync(sitemapPath, 'utf8');
            const matches = [...xml.matchAll(/<loc>([^<]+)<\/loc>/g)];
            urls = matches.map(m => m[1].trim()).filter(Boolean);
          } catch (err) {
            console.warn('⚠️  Could not read sitemap.xml, using fallback URLs.', err.message);
            urls = fallback;
          }

          // Deduplicate and cap
          const unique = Array.from(new Set(urls)).slice(0, 9000);
          fs.writeFileSync('urls.json', JSON.stringify(unique, null, 2));
          console.log(`Collected ${unique.length} URLs for IndexNow ping`);
          EOF
          
          echo "urls<<EOF" >> $GITHUB_OUTPUT
          cat urls.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Submit to IndexNow
        env:
          INDEXNOW_API_KEY: ${{ secrets.INDEXNOW_API_KEY }}
        run: |
          # IndexNow API endpoint
          INDEXNOW_ENDPOINT="https://api.indexnow.org/indexnow"
          
          # Generate API key if not set (use hostname as key)
          if [ -z "$INDEXNOW_API_KEY" ]; then
            INDEXNOW_API_KEY="drsayuj.info"
          fi
          
          # Get URLs from previous step or use default
          if [ -f "urls.json" ]; then
            URLS=$(cat urls.json)
          else
            URLS='["https://www.drsayuj.info/","https://www.drsayuj.info/about","https://www.drsayuj.info/appointments"]'
          fi
          
          # Submit to IndexNow
          curl -X POST "$INDEXNOW_ENDPOINT" \
            -H "Content-Type: application/json" \
            -d "{
              \"host\": \"www.drsayuj.info\",
              \"key\": \"$INDEXNOW_API_KEY\",
              \"urlList\": $URLS
            }" || echo "IndexNow submission failed (non-critical)"
          
          echo "✅ IndexNow submission completed"

      - name: Submit sitemap to search engines
        run: |
          # Submit sitemap to Google
          curl -X POST "https://www.google.com/ping?sitemap=https://www.drsayuj.info/sitemap.xml" || echo "Google ping failed"
          
          # Submit sitemap to Bing
          curl -X POST "https://www.bing.com/ping?sitemap=https://www.drsayuj.info/sitemap.xml" || echo "Bing ping failed"
          
          echo "✅ Sitemap submitted to search engines"
