name: Meta Tag Checker

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Wednesday at 3 AM UTC (8:30 AM IST)
    - cron: '0 3 * * 3'
  workflow_dispatch:

jobs:
  check-meta-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9'

      - name: Setup Node.js
        uses: actions/setup-node@v4
          cache: 'pnpm'
        with:
          node-version: '20'
        run: pnpm install

      - name: Install checker dependency
        run: pnpm add cheerio

      - name: Run meta tag check
        id: check
        timeout-minutes: 10
        continue-on-error: true
        run: |
          if node check-meta-tags.js; then
            echo "check_failed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Meta tag check passed"
          else
            echo "check_failed=true" >> $GITHUB_OUTPUT
            echo "‚ùå Meta tag check failed"
          fi

      - name: Write meta tag report
        timeout-minutes: 1
        run: |
          if [ -f check-meta-tags.js ]; then
            node check-meta-tags.js > meta-tag-report.txt 2>&1 || true
            echo "" >> meta-tag-report.txt
            echo "Check status: ${{ steps.check.outputs.check_failed }}" >> meta-tag-report.txt
          else
            echo "Meta tag check script not found" > meta-tag-report.txt
          fi

      - name: Upload meta tag report
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: meta-tag-report
          path: meta-tag-report.txt

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        timeout-minutes: 2
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reportContent = '';
            try {
              if (fs.existsSync('meta-tag-report.txt')) {
                reportContent = fs.readFileSync('meta-tag-report.txt', 'utf8');
              }
            } catch (error) {
              reportContent = 'Could not read report file';
            }
            
            const checkFailed = '${{ steps.check.outputs.check_failed }}' === 'true';
            const status = checkFailed ? '‚ùå Failed' : '‚úÖ Passed';
            const comment = `## üè∑Ô∏è Meta Tag Check: ${status}\n\n` +
              `${reportContent ? '```\n' + reportContent.substring(0, 1000) + '\n```\n\n' : ''}` +
              `[View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
