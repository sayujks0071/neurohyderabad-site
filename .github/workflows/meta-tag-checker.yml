name: Meta Tag Checker

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Wednesday at 3 AM UTC (8:30 AM IST)
    - cron: '0 3 * * 3'
  workflow_dispatch:

jobs:
  check-meta-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create meta tag checker
        run: |
          cat > check-meta-tags.js << 'EOF'
          const cheerio = require('cheerio');
          
          const BASE_URL = process.env.META_TAG_BASE_URL || 'https://neurohyderabad.org';
          const USER_AGENT = 'Mozilla/5.0 (compatible; MetaTagChecker/1.0)';
          
          const urls = [
            '/',
            '/about',
            '/services',
            '/contact'
          ].map((path) => new URL(path, BASE_URL).toString());

          async function fetchHtml(url) {
            const res = await fetch(url, {
              redirect: 'follow',
              headers: { 'User-Agent': USER_AGENT }
            });
            const data = await res.text();
            return { data, status: res.status, finalUrl: res.url };
          }
          
          async function checkMetaTags(url) {
            const { data, status, finalUrl } = await fetchHtml(url);
            const issues = [];
            
            if (status >= 400) {
              issues.push(`HTTP ${status}`);
            }
            
            const $ = cheerio.load(data);
            
            // Check title
            const title = $('title').first().text().trim();
            
            if (!title) {
              issues.push('Missing <title> tag');
            } else if (title.length < 30) {
              issues.push(`Title too short (${title.length} chars, min 30)`);
            } else if (title.length > 60) {
              issues.push(`Title too long (${title.length} chars, max 60)`);
            }
            
            // Check description
            const description = $('meta[name="description"]').attr('content') || '';
            
            if (!description) {
              issues.push('Missing meta description');
            } else if (description.length < 120) {
              issues.push(`Description too short (${description.length} chars, min 120)`);
            } else if (description.length > 160) {
              issues.push(`Description too long (${description.length} chars, max 160)`);
            }
            
            // Check OG tags
            if ($('meta[property="og:title"]').length === 0) {
              issues.push('Missing og:title');
            }
            if ($('meta[property="og:description"]').length === 0) {
              issues.push('Missing og:description');
            }
            if ($('meta[property="og:image"]').length === 0) {
              issues.push('Missing og:image');
            }
            if ($('meta[property="og:url"]').length === 0) {
              issues.push('Missing og:url');
            }
            
            // Check Twitter Card
            if ($('meta[name="twitter:card"]').length === 0) {
              issues.push('Missing twitter:card');
            }
            
            // Check canonical
            if ($('link[rel="canonical"]').length === 0) {
              issues.push('Missing canonical tag');
            }
            
            return { url, finalUrl, title, description, issues };
          }
          
          async function main() {
            console.log('\nüè∑Ô∏è  Starting Meta Tag Check\n');
            const results = [];
            let hasIssues = false;
            
            for (const url of urls) {
              try {
                const result = await checkMetaTags(url);
                results.push(result);
                
                const redirected = result.finalUrl && result.finalUrl !== url;
                
                if (result.issues.length === 0) {
                  console.log(`‚úÖ ${url}`);
                  if (redirected) {
                    console.log(`   Final: ${result.finalUrl}`);
                  }
                  console.log(`   Title: ${result.title}`);
                  console.log(`   Desc: ${result.description.substring(0, 60)}...`);
                } else {
                  console.log(`‚ö†Ô∏è  ${url}`);
                  if (redirected) {
                    console.log(`   Final: ${result.finalUrl}`);
                  }
                  result.issues.forEach(issue => {
                    console.log(`   - ${issue}`);
                  });
                  hasIssues = true;
                }
                console.log('');
              } catch (error) {
                console.error(`‚ùå ${url}: ${error.message}`);
                hasIssues = true;
              }
            }
            
            if (hasIssues) {
              console.log('‚ö†Ô∏è  Some meta tag issues found.');
              process.exit(1);
            } else {
              console.log('‚úÖ All meta tags are properly configured!');
            }
          }
          
          main().catch(console.error);
          EOF

      - name: Install dependencies
        run: npm install cheerio

      - name: Run meta tag check
        id: check
        timeout-minutes: 10
        continue-on-error: true
        run: |
          if node check-meta-tags.js; then
            echo "check_failed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Meta tag check passed"
          else
            echo "check_failed=true" >> $GITHUB_OUTPUT
            echo "‚ùå Meta tag check failed"
          fi

      - name: Write meta tag report
        timeout-minutes: 1
        run: |
          if [ -f check-meta-tags.js ]; then
            node check-meta-tags.js > meta-tag-report.txt 2>&1 || true
            echo "" >> meta-tag-report.txt
            echo "Check status: ${{ steps.check.outputs.check_failed }}" >> meta-tag-report.txt
          else
            echo "Meta tag check script not found" > meta-tag-report.txt
          fi

      - name: Upload meta tag report
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: meta-tag-report
          path: meta-tag-report.txt

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        timeout-minutes: 2
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reportContent = '';
            try {
              if (fs.existsSync('meta-tag-report.txt')) {
                reportContent = fs.readFileSync('meta-tag-report.txt', 'utf8');
              }
            } catch (error) {
              reportContent = 'Could not read report file';
            }
            
            const checkFailed = '${{ steps.check.outputs.check_failed }}' === 'true';
            const status = checkFailed ? '‚ùå Failed' : '‚úÖ Passed';
            const comment = `## üè∑Ô∏è Meta Tag Check: ${status}\n\n` +
              `${reportContent ? '```\n' + reportContent.substring(0, 1000) + '\n```\n\n' : ''}` +
              `[View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
