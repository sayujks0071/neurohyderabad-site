name: Security Audit
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 4 AM UTC (9:30 AM IST)
    - cron: '0 4 * * 1'
  workflow_dispatch:
jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install
        timeout-minutes: 5
        continue-on-error: false

      - name: Run security audit (production dependencies only)
        id: audit-prod
        continue-on-error: true
        run: |
          echo "Checking production dependencies..."
          pnpm audit --production --audit-level=high || echo "audit_prod_failed=true" >> $GITHUB_OUTPUT
        timeout-minutes: 2

      - name: Run security audit (all dependencies)
        id: audit-all
        continue-on-error: true
        run: |
          echo "Checking all dependencies (including dev)..."
          pnpm audit --audit-level=high || echo "audit_all_failed=true" >> $GITHUB_OUTPUT
        timeout-minutes: 2

      - name: Generate audit report
        if: always()
        continue-on-error: true
        run: |
          mkdir -p reports/security
          pnpm audit --json > reports/security/audit-report.json 2>&1 || true
          pnpm audit --production --json > reports/security/audit-report-prod.json 2>&1 || true
        timeout-minutes: 2

      - name: Upload audit reports
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: reports/security/
          retention-days: 30

      - name: Create security issue (if high/critical in production)
        if: steps.audit-prod.outputs.audit_prod_failed == 'true'
        continue-on-error: true
        timeout-minutes: 2
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let auditData = { vulnerabilities: {} };
            try {
              const report = fs.readFileSync('reports/security/audit-report-prod.json', 'utf8');
              auditData = JSON.parse(report);
            } catch (e) {
              console.log('Could not read audit report');
            }
            const advisories = Object.values(auditData.advisories || {});
            const highSeverity = advisories
              .filter(v => v.severity === 'high' || v.severity === 'critical').length;
            // Also check for 'vulnerabilities' if pnpm changed format or to support npm fallback
            const vulns = Object.values(auditData.vulnerabilities || {});
            const highSeverityLegacy = vulns.filter(v => v.severity === 'high' || v.severity === 'critical').length;
            const totalHigh = Math.max(highSeverity, highSeverityLegacy);
            
            // Re-assign for the check
            const highSeverityCount = totalHigh;
            if (highSeverityCount > 0) {
              const issueBody = `## ðŸ”’ Security Audit Alert\n\n` +
                `**High/Critical vulnerabilities in production dependencies**: ${highSeverity}\n\n` +
                `This workflow detected security vulnerabilities in production dependencies.\n\n` +
                `### Recommended Actions:\n` +
                `1. Review the audit report in workflow artifacts\n` +
                `2. Run \`pnpm audit --fix\` to attempt automatic fixes\n` +
                `3. For breaking changes, manually update affected packages\n` +
                `4. Test thoroughly after updates\n\n` +
                `[View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})\n\n` +
                `_Note: Dev dependency vulnerabilities are tracked but do not trigger this alert._`;
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Security: ${highSeverity} high/critical vulnerabilities in production dependencies`,
                body: issueBody,
                labels: ['security', 'dependencies']
              });
            }

      - name: Summary
        if: always()
        run: |
          echo "## Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.audit-prod.outputs.audit_prod_failed }}" == "true" ]; then
            echo "âŒ **Production dependencies**: High/critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Production dependencies**: No high/critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.audit-all.outputs.audit_all_failed }}" == "true" ]; then
            echo "âš ï¸ **All dependencies**: Some vulnerabilities in dev dependencies (non-blocking)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All dependencies**: No high/critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed reports in workflow artifacts." >> $GITHUB_STEP_SUMMARY
