name: Accessibility Audit (a11y)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 5 AM UTC (10:30 AM IST)
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  accessibility-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # Use pnpm version from package.json#packageManager

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install
        timeout-minutes: 5
        continue-on-error: false

      - name: Build site
        run: pnpm run build
        timeout-minutes: 10
        continue-on-error: false
        env:
          NEXT_PUBLIC_GOOGLE_ANALYTICS_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID }}

      - name: Start server
        timeout-minutes: 5
        continue-on-error: false
        run: |
          pnpm run start &
          sleep 5
          pnpm dlx wait-on http://localhost:3000 --timeout 60000 || (sleep 10 && pnpm dlx wait-on http://localhost:3000 --timeout 60000)

      - name: Install a11y tools
        timeout-minutes: 3
        continue-on-error: false
        run: |
          pnpm add -g pa11y pa11y-ci @axe-core/cli

      - name: Run comprehensive a11y audit
        id: audit
        timeout-minutes: 15
        continue-on-error: true
        run: |
          cat > a11y-audit.js << 'EOF'
          const { exec } = require('child_process');
          const fs = require('fs');
          const util = require('util');
          const execPromise = util.promisify(exec);
          
          const urls = [
            'http://localhost:3000',
            'http://localhost:3000/about',
            'http://localhost:3000/services',
            'http://localhost:3000/contact',
            'http://localhost:3000/services/brain-tumor-surgery-hyderabad',
            'http://localhost:3000/services/spine-surgery-hyderabad'
          ];
          
          const issues = {
            colorContrast: [],
            missingAlt: [],
            missingLabels: [],
            headingOrder: [],
            ariaIssues: [],
            keyboardNav: [],
            tapTargets: []
          };
          
          let totalIssues = 0;
          let criticalIssues = 0;
          
          console.log('‚ôø Starting Comprehensive Accessibility Audit\n');
          console.log('Testing', urls.length, 'pages...\n');
          
          for (const url of urls) {
            console.log(`Testing: ${url}`);
            
            try {
              // Run pa11y
              const { stdout } = await execPromise(`pa11y ${url} --reporter json`);
              const results = JSON.parse(stdout);
              
              const pageIssues = results.issues || [];
              const criticalCount = pageIssues.filter(i => i.type === 'error').length;
              
              console.log(`  Found ${pageIssues.length} issues (${criticalCount} critical)`);
              
              totalIssues += pageIssues.length;
              criticalIssues += criticalCount;
              
              // Categorize issues
              pageIssues.forEach(issue => {
                if (issue.code.includes('color-contrast')) {
                  issues.colorContrast.push({ url, ...issue });
                } else if (issue.code.includes('image-alt')) {
                  issues.missingAlt.push({ url, ...issue });
                } else if (issue.code.includes('label')) {
                  issues.missingLabels.push({ url, ...issue });
                } else if (issue.code.includes('heading')) {
                  issues.headingOrder.push({ url, ...issue });
                } else if (issue.code.includes('aria')) {
                  issues.ariaIssues.push({ url, ...issue });
                }
              });
              
            } catch (error) {
              console.error(`  Error testing ${url}:`, error.message);
            }
          }
          
          // Generate detailed report
          console.log('\n' + '='.repeat(70));
          console.log('üìä Accessibility Audit Summary');
          console.log('='.repeat(70));
          console.log(`Total Issues: ${totalIssues}`);
          console.log(`Critical Issues: ${criticalIssues}`);
          console.log(`\nBreakdown by Category:`);
          console.log(`  üé® Color Contrast: ${issues.colorContrast.length}`);
          console.log(`  üñºÔ∏è  Missing Alt Text: ${issues.missingAlt.length}`);
          console.log(`  üè∑Ô∏è  Missing Form Labels: ${issues.missingLabels.length}`);
          console.log(`  üìù Heading Order: ${issues.headingOrder.length}`);
          console.log(`  üß© ARIA Issues: ${issues.ariaIssues.length}`);
          
          // Detailed issue list
          if (issues.colorContrast.length > 0) {
            console.log('\nüî¥ Color Contrast Issues:');
            issues.colorContrast.slice(0, 5).forEach(i => {
              console.log(`  - ${i.url}`);
              console.log(`    ${i.message}`);
            });
            if (issues.colorContrast.length > 5) {
              console.log(`  ... and ${issues.colorContrast.length - 5} more`);
            }
          }
          
          if (issues.missingAlt.length > 0) {
            console.log('\nüî¥ Missing Alt Text:');
            issues.missingAlt.slice(0, 5).forEach(i => {
              console.log(`  - ${i.url}: ${i.selector}`);
            });
            if (issues.missingAlt.length > 5) {
              console.log(`  ... and ${issues.missingAlt.length - 5} more`);
            }
          }
          
          // Write summary file
          const summary = {
            totalIssues,
            criticalIssues,
            categories: {
              colorContrast: issues.colorContrast.length,
              missingAlt: issues.missingAlt.length,
              missingLabels: issues.missingLabels.length,
              headingOrder: issues.headingOrder.length,
              ariaIssues: issues.ariaIssues.length
            },
            details: issues
          };
          
          fs.writeFileSync('a11y-report.json', JSON.stringify(summary, null, 2));
          
          // Exit with error if critical issues found
          if (criticalIssues > 0) {
            console.log('\n‚ö†Ô∏è  Critical accessibility issues found!');
            process.exit(1);
          } else {
            console.log('\n‚úÖ No critical accessibility issues!');
          }
          EOF
          
          node a11y-audit.js || echo "audit_failed=true" >> $GITHUB_OUTPUT

      - name: Upload accessibility report
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: a11y-report.json
          retention-days: 30

      - name: Create accessibility issue
        if: steps.audit.outputs.audit_failed == 'true'
        continue-on-error: true
        timeout-minutes: 2
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let report = { totalIssues: 0, criticalIssues: 0 };
            try {
              report = JSON.parse(fs.readFileSync('a11y-report.json', 'utf8'));
            } catch (e) {
              console.log('Could not read report file');
            }
            
            const issueBody = `## ‚ôø Accessibility Audit Failed\n\n` +
              `**Total Issues**: ${report.totalIssues}\n` +
              `**Critical Issues**: ${report.criticalIssues}\n\n` +
              `### Breakdown:\n` +
              `- üé® Color Contrast: ${report.categories?.colorContrast || 0}\n` +
              `- üñºÔ∏è Missing Alt Text: ${report.categories?.missingAlt || 0}\n` +
              `- üè∑Ô∏è Missing Labels: ${report.categories?.missingLabels || 0}\n` +
              `- üìù Heading Order: ${report.categories?.headingOrder || 0}\n` +
              `- üß© ARIA Issues: ${report.categories?.ariaIssues || 0}\n\n` +
              `[View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'accessibility'
            });
            
            if (issues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## üîÑ Updated Report\n\n${issueBody}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `‚ôø Accessibility Issues - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['accessibility', 'bug', 'a11y']
              });
            }

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        timeout-minutes: 2
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = { totalIssues: 0, criticalIssues: 0, categories: {} };
            
            try {
              report = JSON.parse(fs.readFileSync('a11y-report.json', 'utf8'));
            } catch (e) {}
            
            const emoji = report.criticalIssues === 0 ? '‚úÖ' : '‚ö†Ô∏è';
            const status = report.criticalIssues === 0 ? 'Passed' : 'Failed';
            
            const comment = `## ‚ôø Accessibility Audit: ${emoji} ${status}\n\n` +
              `**Total Issues**: ${report.totalIssues}\n` +
              `**Critical Issues**: ${report.criticalIssues}\n\n` +
              `[View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Stop server
        if: always()
        run: pkill -f "pnpm run start" || true
