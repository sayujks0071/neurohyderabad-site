name: Blog Generator
on:
  schedule:
    # Run every day at 6:00 AM IST (00:30 UTC)
    - cron: '30 0 * * *'
  workflow_dispatch:
    inputs:
      title:
        description: 'Blog post title'
        required: true
        type: string
      category:
        description: 'Blog category'
        required: false
        type: choice
        options:
          - spine
          - brain
          - epilepsy
          - general
          - recovery
          - cost-guide
          - patient-education
          - technology
          - research
        default: general
      primaryKeyword:
        description: 'Primary SEO keyword'
        required: false
        type: string
      targetLocations:
        description: 'Target locations'
        required: false
        type: string
      useAI:
        description: 'Use AI to generate initial content'
        required: false
        type: boolean
        default: true
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  generate-draft:
    if: ${{ secrets.OPENAI_API_KEY != '' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Generate Blog Post
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "Running scheduled generation..."
            pnpm blog:generate-today
          else
            echo "Running manual generation..."
            CMD_ARGS="--title \"${{ github.event.inputs.title }}\""
            if [ -n "${{ github.event.inputs.category }}" ]; then
              CMD_ARGS="$CMD_ARGS --category ${{ github.event.inputs.category }}"
            fi
            if [ -n "${{ github.event.inputs.primaryKeyword }}" ]; then
              CMD_ARGS="$CMD_ARGS --primaryKeyword \"${{ github.event.inputs.primaryKeyword }}\""
            fi
            if [ -n "${{ github.event.inputs.targetLocations }}" ]; then
              CMD_ARGS="$CMD_ARGS --targetLocations \"${{ github.event.inputs.targetLocations }}\""
            fi
            if [ "${{ github.event.inputs.useAI }}" == "true" ]; then
              CMD_ARGS="$CMD_ARGS --ai"
            fi
            pnpm new:blog -- $CMD_ARGS
          fi

      - name: Lint generated content
        run: pnpm exec next lint

      - name: Type check
        run: pnpm exec tsc --noEmit

      - name: Build to validate
        env:
          NEXT_PUBLIC_GOOGLE_ANALYTICS_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID && secrets.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID || 'G-MMLQCFN4ZJ' }}
        run: pnpm build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'feat(blog): add new blog draft'
          title: 'üìù Blog Draft Generated'
          body: |
            ## üìù Blog Draft Created
            This PR contains a new blog post draft generated via GitHub Actions.
            **Trigger**: ${{ github.event_name }}
            ### Next Steps
            - [ ] Review the generated content
            - [ ] Update frontmatter
            - [ ] Verify medical accuracy
            - [ ] Merge to publish (or schedule)
            Generated by: Blog Generator Workflow
          branch: blog/draft-${{ github.run_id }}
          delete-branch: true
          labels: blog,draft,automated
